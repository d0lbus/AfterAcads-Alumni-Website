<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Management</title>
  <link rel="stylesheet"
    href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css" />
  <link rel="stylesheet" href="../../style/adminAndManager/user.css" />
</head>

<body>
  <section>
    <!-- Header -->
    <header>
      <div>
        <img class="afteracadstext" src="../../assets/logo.png" alt="AfterAcads" />
      </div>
      <!-- Citation: navigation bar - (https://www.youtube.com/watch?v=oLgtucwjVII) -->
      <ul class="nav-links">
        <li><a href="home.html">Home</a></li>
        <li><a href="Registrants.html">Registrants</a></li>
        <li><a href="approvePost.html">Posts</a></li>
        <li><a href="eventsDashboard.html">Events</a></li>
        <li><a href="opportunities.html">Opportunities</a></li>

        <!-- Dropdown for Statistics -->
        <li class="dropdown">
          <a href="javascript:void(0)">Statistics</a>
          <div class="dropdown-content">
            <a href="#">Users</a>
            <a href="#">Posts</a>
            <a href="#">Events</a>
            <a href="#">Opportunities</a>
          </div>
        </li>

        <li><a href="user.html">Users</a></li>
      </ul>
      <div class="profile">
        <li>
          <a href="managerProfile.html">
            <img class="profile-img" src="../../assets/profileIcon.jpg" alt="Profile" />
          </a>
        </li>
      </div>
    </header>

    <!-- User Section -->

    <!-- Citation: user section container design and table for users with it's button - (https://www.youtube.com/watch?v=gUf1fpJwvmA&list=PLR5xnAxI5K55BhYLWb7CqiL7KGSIEOlxO&index=6) -->
    <div class="users-section container">
      <div class="search-and-buttons">
        <input type="text" class="search-input" placeholder="Search..." />
        <button class="btn AddUSer" id="addUserBtn">Add User</button>
      </div>
      <p>Total Users: <span id="totalUsers">16</span></p>
    </div>

    <div class="container1">
      <!-- Table for Users -->
      <table class="user-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>First Name</th>
            <th>
              Last Name
              <button class="sort-button" data-sort="asc" onclick="toggleSort(this, 3)">
                <span class="arrow-up">&#9650;</span>
                <span class="arrow-down">&#9660;</span>
              </button>
            </th>
            <th>Email</th>
            <th>User Role</th>
            <th>Date Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- User Data -->
        </tbody>
      </table>
    </div>
    <!-- Pagination -->
    <div class="pagination">
      <button class="btn pagination-btn" id="prevBtn" disabled>
        Previous
      </button>
      <span id="pageNumber">Page 1</span>
      <button class="btn pagination-btn" id="nextBtn">Next</button>
    </div>

    <!-- User Details Modal For Editing -->
    <div class="user-details-modal" id="userDetailsModal">
      <div class="modal-content">
        <span class="close-btn" id="closeModal">&times;</span>
        <h2>User Details</h2>
        <form id="editUserForm">
          <div>
            <label for="userId">User ID:</label>
            <input type="text" id="userId" name="userId" readonly />
          </div>

          <div>
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName" required />
          </div>

          <div>
            <label for="middleName">Middle Name:</label>
            <input type="text" id="middleName" name="middleName" />
          </div>

          <div>
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName" required />
          </div>

          <div>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required />
          </div>

          <div>
            <label for="createdAt">Date Created:</label>
            <input type="text" id="createdAt" name="createdAt" readonly />
          </div>

          <div>
            <label for="userAddress">Address:</label>
            <textarea id="userAddress" name="userAddress"></textarea>
          </div>

          <div>
            <label for="bio">Bio:</label>
            <textarea id="bio" name="bio"></textarea>
          </div>

          <div>
            <label for="employmentStatus">Employment Status:</label>
            <select id="employmentStatus" name="employmentStatus" required>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
              <option value="Not Looking For Work">Not Looking For Work</option>
            </select>
          </div>

          <div>
            <label for="status">Approval Status:</label>
            <select id="status" name="status" required>
              <option value="approved">Approved</option>
              <option value="pending">Pending</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>

          <div>
            <label for="profilePicture">Profile Picture:</label>
            <input type="file" id="profilePicture" name="profilePicture" accept="image/*" />
            <img id="profilePicturePreview" style="display: none; max-width: 100px; max-height: 100px; margin-top: 10px;" />
          </div>

          <div>
            <label for="userType">User Type:</label>
            <select id="userType" name="userType" required>
              <option value="alumni">Alumni</option>
              <option value="admin">Admin</option>
              <option value="manager">Manager</option>
            </select>
          </div>

          <div>
            <label for="batchId">Batch ID:</label>
            <input type="number" id="batchId" name="batchId" />
          </div>

          <div>
            <label for="schoolId">School:</label>
            <select id="schoolId" name="schoolId" required></select>
          </div>

          <div>
            <label for="courseId">Course:</label>
            <select id="courseId" name="courseId" required></select>
          </div>

          <div>
            <label for="gender">Gender:</label>
            <select id="gender" name="gender" required>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Prefer Not To Say">Prefer Not To Say</option>
            </select>
          </div>

          <button type="submit" class="btn-submit">Save Changes</button>
        </form>
      </div>
    </div>

  </section>

  <!-- JavaScript for Sorting -->
  <!-- Citation: This JavaScript code was debugged with assistance from ChatGPT.  -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const sortTable = (columnIndex, isAscending) => {
        const tbody = document.querySelector("tbody");
        const rows = Array.from(tbody.rows);

        rows.sort((a, b) => {
          const cellA = a.cells[columnIndex].textContent.trim();
          const cellB = b.cells[columnIndex].textContent.trim();

          if (!isNaN(Date.parse(cellA)) && !isNaN(Date.parse(cellB))) {
            return isAscending
              ? new Date(cellA) - new Date(cellB)
              : new Date(cellB) - new Date(cellA);
          }
          if (!isNaN(cellA) && !isNaN(cellB)) {
            return isAscending ? cellA - cellB : cellB - cellA;
          }

          return isAscending
            ? cellA.localeCompare(cellB)
            : cellB.localeCompare(cellA);
        });

        rows.forEach((row) => tbody.appendChild(row));
      };

      const toggleSort = (button, columnIndex) => {
        const isAscending = button.dataset.sort === "asc";
        button.dataset.sort = isAscending ? "desc" : "asc";
        sortTable(columnIndex, !isAscending);
      };

      document.querySelectorAll(".sort-button").forEach((button, index) => {
        button.addEventListener("click", () => toggleSort(button, index));
      });
    });
  </script>

  <!-- JavaScript for Search Input -->
  <!-- Citation: Search Bar In JavaScript (https://www.youtube.com/watch?v=TlP5WIxVirU&t=600s) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.querySelector(".search-input");
      const rows = document.querySelectorAll(".user-table tbody tr");

      searchInput.addEventListener("input", (event) => {
        const searchValue = event.target.value.toLowerCase();
        rows.forEach((row) => {
          const cells = Array.from(row.querySelectorAll("td"));
          const rowText = cells
            .map((cell) => cell.textContent.toLowerCase())
            .join(" ");
          row.style.display = rowText.includes(searchValue) ? "" : "none";
        });
      });
    });
  </script>

  <!-- JavaScript for Pagination -->
  <!-- Citation: JavaScript Pagination (https://www.youtube.com/watch?v=Ynp6Gdd3XVE) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const rowsPerPage = 10;
      const rows = document.querySelectorAll(".user-table tbody tr");
      const totalPages = Math.ceil(rows.length / rowsPerPage);
      let currentPage = 1;

      const showPage = (page) => {
        const startIdx = (page - 1) * rowsPerPage;
        const endIdx = page * rowsPerPage;

        rows.forEach((row, index) => {
          row.style.display =
            index >= startIdx && index < endIdx ? "" : "none";
        });

        document.getElementById("pageNumber").textContent = `Page ${page}`;
        document.getElementById("prevBtn").disabled = page === 1;
        document.getElementById("nextBtn").disabled = page === totalPages;
      };

      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentPage < totalPages) {
          currentPage++;
          showPage(currentPage);
        }
      });

      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          showPage(currentPage);
        }
      });

      showPage(currentPage);
    });
  </script>

  <!-- JavaScript for Adding a User -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const addUserBtn = document.getElementById("addUserBtn");
      const totalUsersDisplay = document.getElementById("totalUsers");
      const userTableBody = document.querySelector(".user-table tbody");
      let userId = 17; // Starting user ID

      const updateTotalUsers = () => {
        totalUsersDisplay.textContent = userTableBody.rows.length;
      };

      addUserBtn.addEventListener("click", () => {
        // Open modal to add user (modal code not shown here)
      });

      // Add new user row code goes here (similar to the existing form logic)
      // After user added, update total users count
    });
  </script>

  <!-- JavaScript for Populating Users Table -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const userTableBody = document.querySelector(".user-table tbody");
    const userDetailsModal = document.getElementById("userDetailsModal");
    const closeModalBtn = document.getElementById("closeModal");
    const editUserForm = document.getElementById("editUserForm");
    const schoolDropdown = document.getElementById("schoolId");
    const courseDropdown = document.getElementById("courseId");
    const profilePicturePreview = document.getElementById("profilePicturePreview");

    const addButtonListeners = () => {
      const editButtons = document.querySelectorAll(".editBtn");
      editButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const userId = button.dataset.id;
          openEditModal(userId);
        });
      });
    };

    // Fetch and populate the users table
    const populateUsersTable = () => {
      fetch("/api/users/getApprovedUsers/?status=approved")
        .then((response) => {
          if (!response.ok) throw new Error("Failed to fetch users");
          return response.json();
        })
        .then((data) => {
          userTableBody.innerHTML = ""; // Clear the table body
          data.forEach((user) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${user.id}</td>
              <td>${user.first_name}</td>
              <td>${user.last_name}</td>
              <td>${user.email}</td>
              <td>${user.role}</td>
              <td>${new Date(user.date_created).toLocaleDateString()}</td>
              <td>
                <button class="editBtn" data-id="${user.id}">Edit</button>
                <button class="restrictBtn" data-id="${user.id}">Restrict</button>
              </td>
            `;
            userTableBody.appendChild(row);
          });

        addButtonListeners();

        })
        .catch((error) => console.error("Error fetching users:", error));
    };

    // Load users table on page load
    populateUsersTable();
  
    // Fetch schools and populate dropdown
    const populateSchoolsDropdown = async (selectedSchoolId) => {
    const response = await fetch('/api/opportunities/schools');
    const schools = await response.json();
    schoolDropdown.innerHTML = '<option value="">Select School</option>';
    schools.forEach((school) => {
        schoolDropdown.innerHTML += `<option value="${school.id}">${school.name}</option>`;
      });
      if (selectedSchoolId) schoolDropdown.value = selectedSchoolId;
    };

    // Fetch courses based on selected school
    const populateCoursesDropdown = async (schoolId, selectedCourseId) => {
      if (!schoolId) {
          courseDropdown.innerHTML = '<option value="">Select Course</option>';
          return;
        }
        const response = await fetch(`/api/opportunities/courses?schoolId=${schoolId}`);
        const courses = await response.json();
        courseDropdown.innerHTML = '<option value="">Select Course</option>';
        courses.forEach((course) => {
          courseDropdown.innerHTML += `<option value="${course.id}">${course.name}</option>`;
        });
        if (selectedCourseId) courseDropdown.value = selectedCourseId;
      };

      // Open modal and populate fields
    const openEditModal = async (userId) => {
      const response = await fetch(`/api/users/getUserById/${userId}`);
      const data = await response.json();

      document.getElementById("userId").value = data.id;
      document.getElementById("firstName").value = data.first_name;
      document.getElementById("middleName").value = data.middle_name;
      document.getElementById("lastName").value = data.last_name;
      document.getElementById("email").value = data.email;
      document.getElementById("createdAt").value = data.date_created;
      document.getElementById("userAddress").value = data.user_address;
      document.getElementById("bio").value = data.bio;
      document.getElementById("employmentStatus").value = data.employment_status;
      document.getElementById("status").value = data.status;
      document.getElementById("userType").value = data.userType;
      document.getElementById("batchId").value = data.batch_id;
      document.getElementById("gender").value = data.gender;

      // Handle profile picture preview
      if (data.profile_picture) {
        profilePicturePreview.src = `data:image/png;base64,${data.profile_picture}`;
        profilePicturePreview.style.display = "block";
      } else {
        profilePicturePreview.style.display = "none";
      }

      // Populate school and course dropdowns
      await populateSchoolsDropdown(data.school_id);
      await populateCoursesDropdown(data.school_id, data.course_id);

      userDetailsModal.style.display = "block";
    };

    // Close modal
    closeModalBtn.addEventListener("click", () => {
      userDetailsModal.style.display = "none";
    });

    // Handle school dropdown change
    schoolDropdown.addEventListener("change", async () => {
       const schoolId = schoolDropdown.value;
      await populateCoursesDropdown(schoolId);
    });

    // Handle form submission
    editUserForm.addEventListener("submit", async (event) => {
      event.preventDefault();

        const formData = new FormData(editUserForm);

        try {
          const response = await fetch('/api/users/updateUser', {
            method: 'PUT',
            body: formData,
          });

          if (!response.ok) throw new Error("Failed to update user");

          const result = await response.json();
          alert(result.message);
          userDetailsModal.style.display = "none";
          // Reload table or fetch users again
        } catch (error) {
          console.error("Error updating user:", error);
        }
      });
  });
  </script>

</body>

</html>