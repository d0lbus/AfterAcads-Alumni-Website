<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Management</title>
  <link rel="stylesheet"
    href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css" />
  <link rel="stylesheet" href="../../style/adminAndManager/user.css" />
</head>

<body>
  <section>
    <!-- Header -->
    <header>
      <div>
        <img class="afteracadstext" src="../../assets/logo.png" alt="AfterAcads" />
      </div>
      <!-- Citation: navigation bar - (https://www.youtube.com/watch?v=oLgtucwjVII) -->
      <ul class="nav-links">
        <li><a href="home.html">Home</a></li>
        <li><a href="Registrants.html">Registrants</a></li>
        <li><a href="approvePost.html">Posts</a></li>
        <li><a href="eventsDashboard.html">Events</a></li>
        <li><a href="opportunities.html">Opportunities</a></li>
        <li><a href="statistics.html">Statistics</a></li>
        <li id="usersNav"><a href="user.html">Users</a></li>
      </ul>
      <div class="profile">
        <li>
          <a href="managerProfile.html">
            <img class="profile-img" src="../../assets/profileIcon.jpg" alt="Profile" />
          </a>
        </li>
      </div>
    </header>

    <!-- User Section -->

    <!-- Citation: user section container design and table for users with it's button - (https://www.youtube.com/watch?v=gUf1fpJwvmA&list=PLR5xnAxI5K55BhYLWb7CqiL7KGSIEOlxO&index=6) -->
    <div class="users-section container">
      <div class="search-and-buttons">
        <input type="text" class="search-input" placeholder="Search..." />
        <button class="btn AddUser" id="addUserBtn">Add User</button>
        <button class="btn AddSchool" id="addSchoolBtn">
          Add School
          <div class="text-field" id="schoolTextField">
            <input type="text" placeholder="Enter school details" />
          </div>
        </button>
        <button class="btn AddCourse" id="openAddCourseModal">Add Course</button>
        <button class="btn AddBatch" id="addBatchBtn">
          Add Batch
          <div class="text-field" id="batchTextField">
            <input type="text" placeholder="Enter batch details" />
          </div>
        </button>
      </div>
    </div>

  

    <!-- Modal Structure -->
    <div id="addCourseModal" class="modal">
      <div class="modal-content">
        <h2>Add Course</h2>
        <select>
          <option value="" disabled selected>Select a course</option>
          <option value="course1">Course 1</option>
          <option value="course2">Course 2</option>
          <option value="course3">Course 3</option>
        </select>
        <input type="text" placeholder="Enter course details" />
        <div class="modal-buttons">
          <button class="btn modal-close" id="closeModalBtn">Close</button>
          <button class="btn modal-save" id="saveModalBtn">Save</button>
        </div>
      </div>
    </div>

    <div class="container1">
      <!-- Table for Users -->
      <table class="user-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>First Name</th>
            <th>
              Last Name
              <button class="sort-button" data-sort="asc" onclick="toggleSort(this, 3)">
                <span class="arrow-up">&#9650;</span>
                <span class="arrow-down">&#9660;</span>
              </button>
            </th>
            <th>Email</th>
            <th>User Role</th>
            <th>Date Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- User Data -->
        </tbody>
      </table>
    </div>
    <!-- Pagination -->
    <div class="pagination">
      <button class="btn pagination-btn" id="prevBtn" disabled>
        Previous
      </button>
      <span id="pageNumber">Page 1</span>
      <button class="btn pagination-btn" id="nextBtn">Next</button>
    </div>

    <!-- User Details Modal For Editing -->
    <div class="user-details-modal" id="userDetailsModal">
      <div class="modal-content">
        <span class="close-btn" id="closeModal">&times;</span>
        <h2>User Details</h2>
        <form id="editUserForm">
          <div>
            <label for="userId">User ID:</label>
            <input type="text" id="userId" name="userId" readonly />
          </div>

          <div>
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName" required />
          </div>

          <div>
            <label for="middleName">Middle Name:</label>
            <input type="text" id="middleName" name="middleName" />
          </div>

          <div>
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName" required />
          </div>

          <div>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required />
          </div>

          <div>
            <label for="userAddress">Address:</label>
            <textarea id="userAddress" name="userAddress"></textarea>
          </div>

          <div>
            <label for="bio">Bio:</label>
            <textarea id="bio" name="bio"></textarea>
          </div>

          <div>
            <label for="employmentStatus">Employment Status:</label>
            <select id="employmentStatus" name="employmentStatus" required>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
              <option value="Not Looking For Work">Not Looking For Work</option>
            </select>
          </div>

          <div>
            <label for="status">Approval Status:</label>
            <select id="status" name="status" required>
              <option value="approved">Approved</option>
              <option value="pending">Pending</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>

          <div>
            <label for="userType">User Type:</label>
            <select id="userType" name="userType" required>
              <option value="alumni">Alumni</option>
              <option value="admin">Admin</option>
              <option value="manager">Manager</option>
            </select>
          </div>

          <div>
            <label for="batchId">Batch ID:</label>
            <input type="number" id="batchId" name="batchId" maxlength="3" placeholder="Batch ID example: 223"
              list="batchIdSuggestions" />
            <datalist id="batchIdSuggestions"></datalist>
          </div>

          <div>
            <label for="schoolId">School:</label>
            <select id="schoolId" name="schoolId" required></select>
          </div>

          <div>
            <label for="courseId">Course:</label>
            <select id="courseId" name="courseId" required></select>
          </div>

          <div>
            <label for="gender">Gender:</label>
            <select id="gender" name="gender" required>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Prefer Not To Say">Prefer Not To Say</option>
            </select>
          </div>

          <button type="submit" class="btn-submit">Save Changes</button>
        </form>
      </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span id="closeAddUserModal" class="close-btn">&times;</span>
        <h2>Add New User</h2>
        <form id="addUserForm">
          <div>
            <label for="addFirstName">First Name:</label>
            <input type="text" id="addFirstName" name="firstName" required />
          </div>

          <div>
            <label for="addMiddleName">Middle Name:</label>
            <input type="text" id="addMiddleName" name="middleName" />
          </div>

          <div>
            <label for="addLastName">Last Name:</label>
            <input type="text" id="addLastName" name="lastName" required />
          </div>

          <div>
            <label for="addEmail">Email:</label>
            <input type="email" id="addEmail" name="email" required />
          </div>

          <div>
            <label for="addPassword">Password:</label>
            <input type="password" id="addPassword" name="password" required />
          </div>

          <div>
            <label for="addBatchId">Batch ID:</label>
            <input type="number" id="addBatchId" name="batchId" maxlength="3" placeholder="Batch ID example: 223"
              list="addBatchSuggestions" required />
            <datalist id="addBatchSuggestions"></datalist>
          </div>

          <div>
            <label for="addSchool">School:</label>
            <select id="addSchool" name="school" required>
              <option value="">Select School</option>
            </select>
          </div>

          <div>
            <label for="addCourse">Course:</label>
            <select id="addCourse" name="course" required>
              <option value="">Select Course</option>
            </select>
          </div>

          <div>
            <label for="addGender">Gender:</label>
            <select id="addGender" name="gender" required>
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Prefer Not To Say">Prefer Not To Say</option>
            </select>
          </div>

          <div>
            <label for="addUserType">User Type:</label>
            <select id="addUserType" name="userType" required>
              <option value="">Select User Type</option>
              <option value="alumni">Alumni</option>
              <option value="admin">Admin</option>
              <option value="manager">Manager</option>
            </select>
          </div>

          <button type="submit" class="btn-submit">Add User</button>
        </form>
      </div>
    </div>

  </section>

  <!-- JavaScript for Sorting -->
  <!-- Citation: This JavaScript code was debugged with assistance from ChatGPT.  -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const sortTable = (columnIndex, isAscending) => {
        const tbody = document.querySelector("tbody");
        const rows = Array.from(tbody.rows);

        rows.sort((a, b) => {
          const cellA = a.cells[columnIndex].textContent.trim();
          const cellB = b.cells[columnIndex].textContent.trim();

          if (!isNaN(Date.parse(cellA)) && !isNaN(Date.parse(cellB))) {
            return isAscending
              ? new Date(cellA) - new Date(cellB)
              : new Date(cellB) - new Date(cellA);
          }
          if (!isNaN(cellA) && !isNaN(cellB)) {
            return isAscending ? cellA - cellB : cellB - cellA;
          }

          return isAscending
            ? cellA.localeCompare(cellB)
            : cellB.localeCompare(cellA);
        });

        rows.forEach((row) => tbody.appendChild(row));
      };

      const toggleSort = (button, columnIndex) => {
        const isAscending = button.dataset.sort === "asc";
        button.dataset.sort = isAscending ? "desc" : "asc";
        sortTable(columnIndex, !isAscending);
      };

      document.querySelectorAll(".sort-button").forEach((button, index) => {
        button.addEventListener("click", () => toggleSort(button, index));
      });
    });
  </script>

  <!-- JavaScript for Search Input -->
  <!-- Citation: Search Bar In JavaScript (https://www.youtube.com/watch?v=TlP5WIxVirU&t=600s) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.querySelector(".search-input");
      const rows = document.querySelectorAll(".user-table tbody tr");

      searchInput.addEventListener("input", (event) => {
        const searchValue = event.target.value.toLowerCase();
        rows.forEach((row) => {
          const cells = Array.from(row.querySelectorAll("td"));
          const rowText = cells
            .map((cell) => cell.textContent.toLowerCase())
            .join(" ");
          row.style.display = rowText.includes(searchValue) ? "" : "none";
        });
      });
    });
  </script>

  <!-- JavaScript for Pagination -->
  <!-- Citation: JavaScript Pagination (https://www.youtube.com/watch?v=Ynp6Gdd3XVE) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const rowsPerPage = 10;
      const rows = document.querySelectorAll(".user-table tbody tr");
      const totalPages = Math.ceil(rows.length / rowsPerPage);
      let currentPage = 1;

      const showPage = (page) => {
        const startIdx = (page - 1) * rowsPerPage;
        const endIdx = page * rowsPerPage;

        rows.forEach((row, index) => {
          row.style.display =
            index >= startIdx && index < endIdx ? "" : "none";
        });

        document.getElementById("pageNumber").textContent = `Page ${page}`;
        document.getElementById("prevBtn").disabled = page === 1;
        document.getElementById("nextBtn").disabled = page === totalPages;
      };

      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentPage < totalPages) {
          currentPage++;
          showPage(currentPage);
        }
      });

      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          showPage(currentPage);
        }
      });

      showPage(currentPage);
    });
  </script>

  <!--Add Course Modal -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const addCourseModal = document.getElementById("addCourseModal");
      const openModalBtn = document.getElementById("openAddCourseModal"); // Button to open modal
      const closeModalBtn = document.getElementById("closeModalBtn"); // Close button
      const saveModalBtn = document.getElementById("saveModalBtn"); // Save button
  
      // Function to open the modal
      const openModal = () => {
        addCourseModal.style.display = "flex"; // Show modal (flex for centering, can be adjusted)
      };
  
      // Function to close the modal
      const closeModal = () => {
        addCourseModal.style.display = "none"; // Hide modal
      };
  
      // Handle open modal button click
      openModalBtn.addEventListener("click", openModal);
  
      // Handle close modal button click
      closeModalBtn.addEventListener("click", closeModal);
  
      // Handle save button click
      saveModalBtn.addEventListener("click", () => {
        const courseSelect = addCourseModal.querySelector("select");
        const courseDetails = addCourseModal.querySelector("input[type='text']").value;
  
        if (!courseSelect.value) {
          alert("Please select a course.");
          return;
        }
  
        if (!courseDetails) {
          alert("Please enter course details.");
          return;
        }
  
        console.log("Saving course data:", {
          course: courseSelect.value,
          details: courseDetails,
        });
  
        // Close the modal after saving
        closeModal();
      });
    });
  </script>
  

  <!-- JavaScript for Populating Users Table and Edit Modal -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const userTableBody = document.querySelector(".user-table tbody");
      const userDetailsModal = document.getElementById("userDetailsModal");
      const closeModalBtn = document.getElementById("closeModal");
      const editUserForm = document.getElementById("editUserForm");
      const schoolDropdown = document.getElementById("schoolId");
      const courseDropdown = document.getElementById("courseId");
      const batchIdInput = document.getElementById("batchId");
      const batchIdSuggestions = document.getElementById("batchIdSuggestions");

    const addButtonListeners = () => {
      const editButtons = document.querySelectorAll(".editBtn");
      editButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const userId = button.dataset.id;
          openEditModal(userId);
        });
      });
    };

    const addStatusToggleButtonListeners = () => {
      document.querySelectorAll(".restrictBtn").forEach((button) => {
        button.addEventListener("click", (event) => {
          const userEmail = button.getAttribute("data-email"); 
          const currentStatus = button.textContent.trim().toLowerCase(); 

          
          const newStatus = currentStatus === "restrict" ? "restricted" : "approved";

          console.log("Sending data:", { email: userEmail, status: newStatus }); 

          // Send request to update user status
          fetch(`/api/users/updateStatus`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: userEmail, status: newStatus }), 
          })
            .then((response) => {
              if (!response.ok) throw new Error("Failed to update user status");
              return response.json();
            })
            .then(() => {
              // Change the button text to reflect the new status
              button.textContent = newStatus === "restricted" ? "Unrestrict" : "Restrict";

              console.log(`Status updated to: ${newStatus}`);
            })
            .catch((error) => console.error("Error updating user status:", error));
        });
      });
    };

    // Fetch and populate the users table
    const populateUsersTable = () => {
    fetch("/api/users/getApprovedUsers/?status=approved")
      .then((response) => {
        if (!response.ok) throw new Error("Failed to fetch users");
        return response.json();
      })
      .then((data) => {
        userTableBody.innerHTML = ""; // Clear the table body
        data.forEach((user) => {
          const row = document.createElement("tr");
          const isRestricted = user.status === "restricted"; // Check if the user is restricted
          row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.first_name}</td>
            <td>${user.last_name}</td>
            <td>${user.email}</td>
            <td>${user.userType}</td>
            <td>${new Date(user.date_created).toLocaleDateString()}</td>
            <td>
              <button class="editBtn" data-id="${user.id}">Edit</button>
              <button class="restrictBtn" data-email="${user.email}">
                ${isRestricted ? "Unrestrict" : "Restrict"}
              </button>
            </td>
          `;
          userTableBody.appendChild(row);
        });

        addButtonListeners();
        addStatusToggleButtonListeners();
      })
      .catch((error) => console.error("Error fetching users:", error));
  };

      // Load users table on page load
      populateUsersTable();

      // Fetch schools and populate dropdown
      const populateSchoolsDropdown = async (selectedSchoolId) => {
        const response = await fetch('/api/opportunities/schools');
        const schools = await response.json();
        schoolDropdown.innerHTML = '<option value="">Select School</option>';
        schools.forEach((school) => {
          schoolDropdown.innerHTML += `<option value="${school.id}">${school.name}</option>`;
        });
        if (selectedSchoolId) schoolDropdown.value = selectedSchoolId;
      };

      // Fetch courses based on selected school
      const populateCoursesDropdown = async (schoolId, selectedCourseId) => {
        if (!schoolId) {
          courseDropdown.innerHTML = '<option value="">Select Course</option>';
          return;
        }
        const response = await fetch(`/api/opportunities/courses?schoolId=${schoolId}`);
        const courses = await response.json();
        courseDropdown.innerHTML = '<option value="">Select Course</option>';
        courses.forEach((course) => {
          courseDropdown.innerHTML += `<option value="${course.id}">${course.name}</option>`;
        });
        if (selectedCourseId) courseDropdown.value = selectedCourseId;
      };

      // Fetch and populate batch suggestions
      const populateBatchSuggestions = async (selectedBatchId) => {
        try {
          const batchIdInput = document.getElementById("batchId");
          const batchIdSuggestions = document.getElementById("batchIdSuggestions");

          const response = await fetch("/api/users/getBatches");
          if (!response.ok) throw new Error("Failed to fetch batches.");

          const batches = await response.json();

          // Clear existing suggestions
          batchIdSuggestions.innerHTML = "";

          // Populate datalist with batches, excluding id #1
          batches.forEach((batch) => {
            if (batch.id !== 1) {
              const option = document.createElement("option");
              option.value = batch.batch_number;
              batchIdSuggestions.appendChild(option);
            }
          });

          // Set selected batch ID if provided
          if (selectedBatchId) {
            const selectedBatch = batches.find((batch) => batch.id === selectedBatchId);
            if (selectedBatch) {
              batchIdInput.value = selectedBatch.batch_number;
            }
          }
        } catch (error) {
          console.error("Error populating batch suggestions:", error);
        }
      };

      // Restrict input to 3 digits and display instruction
      batchIdInput.addEventListener("input", () => {
        const value = batchIdInput.value;
        if (value.length > 3) {
          batchIdInput.value = value.slice(0, 3); // Enforce 3-digit restriction
        }
      });

      // Open modal and populate fields
      const openEditModal = async (userId) => {
        const response = await fetch(`/api/users/getUserById/${userId}`);
        const data = await response.json();
        console.log("User data:", data);

        document.getElementById("userId").value = data.id;
        document.getElementById("firstName").value = data.first_name;
        document.getElementById("middleName").value = data.middle_name;
        document.getElementById("lastName").value = data.last_name;
        document.getElementById("email").value = data.email;
        document.getElementById("userAddress").value = data.user_address;
        document.getElementById("bio").value = data.bio;
        document.getElementById("employmentStatus").value = data.employment_status;
        document.getElementById("status").value = data.status;
        document.getElementById("userType").value = data.userType;
        document.getElementById("gender").value = data.gender;

        // Populate school and course dropdowns and batch id
        await populateSchoolsDropdown(data.school_id);
        await populateCoursesDropdown(data.school_id, data.course_id);
        await populateBatchSuggestions(data.batch_id);

        userDetailsModal.style.display = "flex";
      };

      // Close modal
      closeModalBtn.addEventListener("click", () => {
        userDetailsModal.style.display = "none";
      });

      // Handle school dropdown change
      schoolDropdown.addEventListener("change", async () => {
        const schoolId = schoolDropdown.value;
        await populateCoursesDropdown(schoolId);
      });

      // Handle form submission
      editUserForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        // Convert FormData to JSON
        const formData = new FormData(editUserForm);
        const jsonData = Object.fromEntries(formData.entries()); 

        console.log("Data being sent to backend:", jsonData);

        try {
          const response = await fetch('/api/users/updateUser', {
            method: 'PUT',
            headers: {
              "Content-Type": "application/json", 
            },
            body: JSON.stringify(jsonData), 
          });

          if (!response.ok) throw new Error("Failed to update user");

          const result = await response.json();
          alert(result.message);
          userDetailsModal.style.display = "none";
          // Reload table or fetch users again
        } catch (error) {
          console.error("Error updating user:", error);
        }
      });

    });
  </script>

  <!-- Script for Adding Users-->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const addUserBtn = document.getElementById("addUserBtn");
      const addUserModal = document.getElementById("addUserModal");
      const closeAddUserModal = document.getElementById("closeAddUserModal");
      const addUserForm = document.getElementById("addUserForm");
      const addSchoolDropdown = document.getElementById("addSchool");
      const addCourseDropdown = document.getElementById("addCourse");
      const addBatchSuggestions = document.getElementById("addBatchSuggestions");

      // Fetch and populate schools dropdown
      const populateAddSchoolsDropdown = async () => {
        const response = await fetch("/api/opportunities/schools");
        const schools = await response.json();
        addSchoolDropdown.innerHTML = '<option value="">Select School</option>';
        schools.forEach((school) => {
          addSchoolDropdown.innerHTML += `<option value="${school.id}">${school.name}</option>`;
        });
      };

      // Fetch and populate courses dropdown based on selected school
      const populateAddCoursesDropdown = async (schoolId) => {
        if (!schoolId) {
          addCourseDropdown.innerHTML = '<option value="">Select Course</option>';
          return;
        }
        const response = await fetch(`/api/opportunities/courses?schoolId=${schoolId}`);
        const courses = await response.json();
        addCourseDropdown.innerHTML = '<option value="">Select Course</option>';
        courses.forEach((course) => {
          addCourseDropdown.innerHTML += `<option value="${course.id}">${course.name}</option>`;
        });
      };

      // Fetch and populate batch suggestions
      const populateAddBatchSuggestions = async () => {
        const response = await fetch("/api/users/getBatches");
        const batches = await response.json();
        addBatchSuggestions.innerHTML = "";
        batches.forEach((batch) => {
          if (batch.id !== 1) {
            const option = document.createElement("option");
            option.value = batch.batch_number;
            addBatchSuggestions.appendChild(option);
          }
        });
      };

      // Open Add User Modal
      addUserBtn.addEventListener("click", async () => {
        await populateAddSchoolsDropdown();
        await populateAddBatchSuggestions();
        addUserModal.style.display = "flex";
      });

      // Close Add User Modal
      closeAddUserModal.addEventListener("click", () => {
        addUserModal.style.display = "none";
      });


      // Handle school dropdown change in Add User Modal
      addSchoolDropdown.addEventListener("change", async () => {
        const schoolId = addSchoolDropdown.value;
        await populateAddCoursesDropdown(schoolId);
      });

      // Handle form submission to add user
      addUserForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(addUserForm);

        try {
          const response = await fetch("/api/users/addUser", {
            method: "POST",
            body: JSON.stringify(Object.fromEntries(formData)),
            headers: { "Content-Type": "application/json" }, // Important for JSON
          });

          if (!response.ok) throw new Error("Failed to add user.");

          const result = await response.json();
          alert(result.message);

          addUserForm.reset();

          addUserModal.style.display = "none";
        } catch (error) {
          console.error("Error adding user:", error);
        }
      });
    });
  </script>

  <!-- Script for Checking User Details if Admin or Manager-->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Fetch user details from the backend
      fetch("/api/users/details")
        .then((response) => {
          if (!response.ok) {
            throw new Error("Failed to fetch user details");
          }
          return response.json();
        })
        .then((user) => {
          // Check if the user type is "manager" and hide the "Users" section
          if (user.userType === "manager") {
            const usersNav = document.getElementById("usersNav");
            const usersBox = document.getElementById("usersBox");

            if (usersNav) usersNav.style.display = "none"; // Hide nav link
            if (usersBox) usersBox.style.display = "none"; // Hide box
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          // Redirect to login page if not logged in
          window.location.href = "/adminAndManager/login.html";
        });
    });

  </script>
</body>

</html>