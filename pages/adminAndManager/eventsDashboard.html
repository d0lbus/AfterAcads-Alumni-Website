<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upcoming Events</title>
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css" />
    <link rel="stylesheet" href="../../style/adminAndManager/events-dashboard.css" />
</head>

<body>
    <section>
        <header>
            <div>
                <img class="afteracadstext" src="../../assets/logo.png" alt="AfterAcads" />
            </div>
            <ul class="nav-links">
                <li><a href="home.html">Home</a></li>
                <li><a href="Registrants.html">Registrants</a></li>
                <li><a href="approvePost.html">Posts</a></li>
                <li><a href="eventsDashboard.html">Events</a></li>
                <li><a href="opportunities.html">Opportunities</a></li>
                <li><a href="statistics.php">Statistics</a></li>
                <li><a href="user.html">Users</a></li>
            </ul>
            <div class="profile">
                <li><a href="managerProfile.html"><img class="profile-img" src="../../assets/profileIcon.jpg"
                            alt="Profile" /></a></li>
            </div>
        </header>
    </section>

    <div class="events-section container">
        <div class="search-and-buttons">
            <input type="text" class="search-input" placeholder="Search..." />
            <div class="button-group">
              <select class="filter-dropdown">
                <option value="">Filter by School</option>
                <!-- Dynamic options for schools -->
              </select>
              <div class="button-group">
                <button class="btn btn-upcoming">Upcoming Events</button>
                <button class="btn finished">Finished Events</button>
                <button class="btn archived">Archived/Denied Events</button>
                <button class="btn add">Add Event</button>
              </div>
            </div>
            </div>
          </div>

        <!-- Table for Upcoming Events -->
        <table class="event-table upcoming-table">
                <thead>
                <tr>
                    <th>Event ID</th>
                    <th>Event</th>
                    <th>Host</th>
                    <th>
                    Date
                    <button class="sort-button" data-sort="asc" onclick="toggleSort(this, 2)">
                        <span class="arrow-up">&#9650;</span>
                        <span class="arrow-down">&#9660;</span>
                    </button>
                    </th>
                    <th>Time</th>
                    <th>Location</th>
                    <th>Description</th>
                    <th>School</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody></tbody>
        </table>

        <!-- Table for Finished Events -->
        <table class="event-table finished-table" style="display: none;">
                <thead>
                <tr>
                    <th>Event ID</th>
                    <th>Event</th>
                    <th>Host</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Location</th>
                    <th>Description</th>
                    <th>School</th>
                </tr>
                </thead>
                <tbody></tbody>
        </table>

        <!-- Table for Archived Events -->
        <table class="event-table archived-table" style="display: none;">
                <thead>
                <tr>
                    <th>Event ID</th>
                    <th>Event</th>
                    <th>Host</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Location</th>
                    <th>Description</th>
                    <th>School</th>
                </tr>
                </thead>
                <tbody></tbody>
        </table>
    </div>

    <!-- Modal for Editing Event -->
    <div class="event-details-modal" id="eventDetailsModal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" id="closeModal">&times;</span>
            <h2>Edit Event</h2>
            <form id="editEventForm">
                <!-- Image Preview -->
                <label for="eventImagePreview">Event Image Preview:</label>
                <img id="eventImagePreview" style="display: none; max-width: 100%; height: auto;" alt="Event Image Preview">                

                <!-- Event ID-->
                <label for="eventID">ID:</label>
                <input type="text" id="eventId" name="eventId" readonly />

                <!-- Title -->
                <label for="eventTitle">Title:</label>
                <input type="text" id="eventTitle" name="eventTitle" required />
    
                <!-- Description -->
                <label for="eventDescription">Description:</label>
                <textarea id="eventDescription" name="eventDescription" required></textarea>
    
                <!-- School Dropdown -->
                <label for="eventSchool">School:</label>
                <select id="eventSchool" name="eventSchool" required>
                    <option value="">Select School</option>
                    <!-- Options will be dynamically populated -->
                </select>
    
                <!-- Host -->
                <label for="eventHost">Host:</label>
                <input type="text" id="eventHost" name="eventHost" required />
    
                <!-- Date -->
                <label for="eventDate">Date:</label>
                <input type="date" id="eventDate" name="eventDate" required max="" />
    
                <!-- Time -->
                <label for="eventTime">Time:</label>
                <input type="time" id="eventTime" name="eventTime" required />
    
                <!-- Location -->
                <label for="eventLocation">Location:</label>
                <input type="text" id="eventLocation" name="eventLocation" required />
    
                <!-- Image Uploaded-->
                <label for="eventImage">Event Image:</label>
                <input type="file" id="eventImage" name="eventImage" accept="image/*" />
    
                <!-- Alternate Text for Image -->
                <label for="altText">Image Alt Text:</label>
                <input type="text" id="altText" name="altText" />
    
                <!-- Save Button -->
                <button type="submit" id="saveChanges">Save Changes</button>
            </form>
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // DOM elements
            const searchInput = document.querySelector(".search-input");
            const mainDropdown = document.querySelector(".filter-dropdown"); 
            const eventSchoolDropdown = document.getElementById("eventSchool"); 
            const modal = document.getElementById("eventDetailsModal");
            const closeModalButton = document.getElementById("closeModal");
            const form = document.getElementById("editEventForm");

             // Event Image Input and Preview
            const eventImageInput = document.getElementById("eventImage");
            const eventImagePreview = document.getElementById("eventImagePreview");
    
            // Buttons for table switching
            const btnUpcoming = document.querySelector(".btn-upcoming");
            const btnFinished = document.querySelector(".btn-finished");
            const btnArchived = document.querySelector(".btn-archived");
    
            // Tables
            const upcomingTable = document.querySelector(".upcoming-table");
            const finishedTable = document.querySelector(".finished-table");
            const archivedTable = document.querySelector(".archived-table");
    
            // Fetch and populate events
            fetch('/api/events/status')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch events');
                    return response.json();
                })
                .then(data => {
                    populateTable('upcoming-table', data.upcoming);
                    populateTable('finished-table', data.finished);
                    populateTable('archived-table', data.archived);
                })
                .catch(error => console.error('Error fetching events:', error));
    
             // Fetch and populate schools 
            fetch('/api/events/schools')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch schools');
                    return response.json();
                })
                .then(data => {
                    // Populate Dropdown in Dashboard
                    if (mainDropdown) {
                        mainDropdown.innerHTML = `<option value="">Filter by School</option>`;
                        data.forEach(school => {
                            mainDropdown.innerHTML += `<option value="${school.name}">${school.name}</option>`;
                        });
                    }
                })
                .catch(error => console.error('Error fetching schools:', error));
    
            // Table switching functionality
            btnUpcoming.addEventListener("click", () => switchTable(upcomingTable));
            btnFinished.addEventListener("click", () => switchTable(finishedTable));
            btnArchived.addEventListener("click", () => switchTable(archivedTable));
    
            function switchTable(activeTable) {
                [upcomingTable, finishedTable, archivedTable].forEach(table => {
                    table.style.display = table === activeTable ? "table" : "none";
                });
            }
    
            // Filter events by school
            mainDropdown.addEventListener("change", (event) => {
                const selectedSchool = event.target.value.toLowerCase();
                filterRowsBySchool(selectedSchool);
            });
    
            // Search events
            searchInput.addEventListener("input", (event) => {
                const searchValue = event.target.value.trim().toLowerCase();
                filterRowsBySearch(searchValue);
            });
    
            // Handle button clicks
            document.addEventListener("click", (event) => {
                if (event.target.classList.contains("mark-done")) {
                    const row = event.target.closest("tr");
                    moveToTable(row, "finished-table");
                    updateEventStatus(getEventIdFromRow(row), "finished");
                } else if (event.target.classList.contains("archive")) {
                    const row = event.target.closest("tr");
                    moveToTable(row, "archived-table");
                    updateEventStatus(getEventIdFromRow(row), "archived");
                } else if (event.target.classList.contains("edit")) {
                    const eventId = getEventIdFromRow(event.target.closest("tr"));
                    openEditEventModal(eventId);
                }
            });
    
            // Populate table with event data
            function populateTable(tableClass, events) {
                const tableBody = document.querySelector(`.${tableClass} tbody`);
                tableBody.innerHTML = "";
    
                events.forEach(event => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${event.event_id}</td>
                        <td>${event.title}</td>
                        <td>${event.host}</td>
                        <td>${new Date(event.date).toLocaleDateString()}</td>
                        <td>${event.time}</td>
                        <td>${event.location}</td>
                        <td>${event.description}</td>
                        <td>${event.school}</td>
                        <td class="action-buttons">
                            ${tableClass === "upcoming-table" ? `
                                <button class="btn mark-done">Mark as Done</button>
                                <button class="btn archive">Archive</button>
                            ` : ""}
                            <button class="btn edit">Edit</button>
                        </td>
                    `;
                    row.dataset.eventId = event.event_id;
                    tableBody.appendChild(row);
                });
            }
    
            // Move row to a different table
            function moveToTable(row, targetTableClass) {
                const targetTableBody = document.querySelector(`.${targetTableClass} tbody`);
                row.querySelector(".action-buttons").innerHTML = ""; // Clear action buttons for finished/archived
                targetTableBody.appendChild(row);
            }
    
            // Get event ID from the row
            function getEventIdFromRow(row) {
                return row.dataset.eventId;
            }
    
            // Update event status in the database
            function updateEventStatus(eventId, status) {
                fetch("/api/events/updateStatus", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ event_id: eventId, status }),
                })
                    .then(response => {
                        if (!response.ok) throw new Error("Failed to update event status");
                        return response.json();
                    })
                    .then(data => console.log(data.message))
                    .catch(error => console.error("Error updating event status:", error));
            }

            // Populate schools dropdown in Modal
            function populateSchoolsDropdown() {
                return fetch('/api/events/schools')
                    .then(response => {
                        if (!response.ok) throw new Error("Failed to fetch schools");
                        return response.json();
                    })
                    .then(data => {
                        const schoolDropdown = document.getElementById("eventSchool");
                        schoolDropdown.innerHTML = `<option value="">Select School</option>`;
                        data.forEach(school => {
                            schoolDropdown.innerHTML += `<option value="${school.id}">${school.name}</option>`;
                        });
                    })
                    .catch(error => console.error("Error fetching schools:", error));
            }

    
            // Open modal and populate fields
            async function openEditEventModal(eventId) {
                try {
                    // Ensure schools dropdown is populated before setting the value
                    await populateSchoolsDropdown();

                    // Fetch event details
                    const response = await fetch(`/api/events/details/${eventId}`);
                    if (!response.ok) throw new Error("Failed to fetch event details");
                    const data = await response.json();

                    // Populate modal fields
                    document.getElementById("eventId").value = data.event_id || "";
                    document.getElementById("eventTitle").value = data.title || "";
                    document.getElementById("eventDescription").value = data.description || "";
                    document.getElementById("eventDate").value = data.date || "";
                    document.getElementById("eventTime").value = data.time || "";
                    document.getElementById("eventLocation").value = data.location || "";
                    document.getElementById("eventHost").value = data.host || "";

                    // Set selected school
                    const schoolDropdown = document.getElementById("eventSchool");
                    schoolDropdown.value = data.school_id || ""; // Ensure `data.school_id` matches the `value` of dropdown options

                    // Handle image preview
                    const eventImagePreview = document.getElementById("eventImagePreview");
                    if (data.image_path) {
                        eventImagePreview.src = `/uploads/${data.image_path}`;
                        eventImagePreview.style.display = "block";
                    } else {
                        eventImagePreview.style.display = "none";
                    }

                    // Show modal
                    const modal = document.getElementById("eventDetailsModal");
                    modal.style.display = "block";
                } catch (error) {
                    console.error("Error opening edit modal:", error);
                }
            }
    

            eventImageInput.addEventListener("change", (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        eventImagePreview.src = e.target.result;
                        eventImagePreview.style.display = "block";
                    };
                    reader.readAsDataURL(file);
                } else {
                    eventImagePreview.style.display = "none";
                }
            });

            // Close modal
            closeModalButton.addEventListener("click", () => {
                modal.style.display = "none";
            });
    
            window.addEventListener("click", (event) => {
                if (event.target === modal) modal.style.display = "none";
            });
    
            // Submit the form to update event details
            form.addEventListener("submit", (event) => {
                event.preventDefault(); // Prevent default form submission

                const formData = new FormData(form);
                for (const [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`); // Debugging log
                }

                fetch("/api/events/update", {
                    method: "PUT",
                    body: formData, // Use FormData directly
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => {
                                throw new Error(errData.error || "Failed to update event");
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data.message); // Log the success message
                        alert(data.message); // Show a success alert
                        modal.style.display = "none"; // Close modal on success
                        location.reload(); // Reload the page to reflect changes
                    })
                    .catch(error => {
                        console.error("Error updating event:", error);
                        alert(`Error: ${error.message}`); // Show error message
                    });
            });
    
            // Restrict past dates for the date input
            const dateInput = document.getElementById("eventDate");
            const today = new Date().toISOString().split("T")[0];
            dateInput.setAttribute("min", today);
    
            // Filter rows by school
            function filterRowsBySchool(schoolName) {
                const rows = document.querySelectorAll(".event-table tbody tr");
                rows.forEach(row => {
                    const schoolCell = row.querySelector("td:nth-child(7)").textContent.toLowerCase();
                    row.style.display = schoolCell.includes(schoolName) ? "" : "none";
                });
            }
    
            // Filter rows by search
            function filterRowsBySearch(searchValue) {
                const rows = document.querySelectorAll(".event-table tbody tr");
                rows.forEach(row => {
                    const rowText = row.textContent.toLowerCase();
                    row.style.display = rowText.includes(searchValue) ? "" : "none";
                });
            }
        });
    </script>
</body>

</html>