<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Posts</title>
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css" />
    <link rel="stylesheet" href="../../style/adminAndManager/approvePost.css" />
    <script src="script.js" defer></script>
</head>

<body>
    <section>
        <header>
            <div>
                <img class="afteracadstext" src="../../assets/logo.png" alt="AfterAcads" />
            </div>
            <ul class="nav-links">
                <li><a href="home.html">Home</a></li>
                <li><a href="Registrants.html">Registrants</a></li>
                <li><a href="approvePost.html">Posts</a></li>
                <li><a href="eventsDashboard.html">Events</a></li>
                <li><a href="opportunities.html">Opportunities</a></li>
                <li><a href="statistics.php">Statistics</a></li>
                <li><a href="user.html">Users</a></li>
            </ul>
            <div class="profile">
                <li><a href="managerProfile.html"><img class="profile-img"
                            src="../../assets/profileIcon.jpg" alt="Profile" /></a></li>
            </div>
        </header>
    </section>
    <div class="posts-section container">
        <div class="search-and-buttons">
            <input type="text" class="search-input" placeholder="Search..." />
            <div class="button-group">
                <button class="btn pending">Pending Posts</button>
                <button class="btn approved">Approved Posts</button>
                <button class="btn denied">Denied Posts</button>
            </div>
        </div>

        <!-- Table for Pending Posts -->
        <table class="post-table pending-table">
            <thead>
            <tr>
                <th>Post ID</th>
                <th>Email</th>
                <th>Author</th>
                <th>Content</th>
                <th>Date
                <button class="sort-button" data-sort="asc" onclick="toggleSort(this, 3)">
                    <span class="arrow-up">&#9650;</span>
                    <span class="arrow-down">&#9660;</span>
                </button>
                </th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            <!-- Dynamic Rows Here -->
            </tbody>
        </table>
    
        <!-- Table for Approved Posts -->
        <table class="post-table approved-table" style="display: none;">
            <thead>
            <tr>
                <th>Post ID</th>
                <th>Email</th>
                <th>Author</th>
                <th>Content</th>
                <th>Date
                <button class="sort-button" data-sort="asc" onclick="toggleSort(this, 3)">
                    <span class="arrow-up">&#9650;</span>
                    <span class="arrow-down">&#9660;</span>
                </button>
                </th>
            </tr>
            </thead>
            <tbody>
            <!-- Dynamic Rows Here -->
            </tbody>
        </table>
    
        <!-- Table for Rejected Posts -->
        <table class="post-table denied-table" style="display: none;">
            <thead>
            <tr>
                <th>Post ID</th>
                <th>Email</th>
                <th>Author</th>
                <th>Content</th>
                <th>Date
                <button class="sort-button" data-sort="asc" onclick="toggleSort(this, 3)">
                    <span class="arrow-up">&#9650;</span>
                    <span class="arrow-down">&#9660;</span>
                </button>
                </th>
            </tr>
            </thead>
            <tbody>
            <!-- Dynamic Rows Here -->
            </tbody>
        </table>
    </div>

    <div class="post-details-modal" id="postDetailsModal" style="display: none;">
        <div class="modal-content">
          <span class="close-btn" id="closeModal">&times;</span>
          <h2>Post Details</h2>
          <hr class="modal-divider">
          <p><strong>Email:</strong> <span id="postEmail"></span></p>
          <p><strong>Author:</strong> <span id="postAuthor"></span></p>
          <p><strong>Content:</strong> <span id="postContent"></span></p>
          <p><strong>Date:</strong> <span id="postDate"></span></p>
          <p><strong>School:</strong> <span id="postSchool"></span></p>
          <p><strong>Course:</strong> <span id="postCourse"></span></p>
          <p><strong>Batch:</strong> <span id="postBatch"></span></p>
          <p><strong>Image:</strong></p>
          <img id="postImage" style="display: none; max-width: 100%;" />
        </div>
    </div>

    <!-- Script for the Tables -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const rows = document.querySelectorAll(".post-table tbody tr");
            const modal = document.getElementById("postDetailsModal");
            const closeModalButton = document.getElementById("closeModal");
            const statusButtons = document.querySelectorAll(".button-group .btn");
            const actionButtons = document.querySelectorAll(".action-buttons button");

            // Function to switch between tables
            const toggleTable = (status) => {
                const pendingTable = document.querySelector(".pending-table");
                const approvedTable = document.querySelector(".approved-table");
                const deniedTable = document.querySelector(".denied-table");

                if (status === "approved") {
                    pendingTable.style.display = "none";
                    approvedTable.style.display = "table";
                    deniedTable.style.display = "none";
                } else if (status === "denied") {
                    pendingTable.style.display = "none";
                    approvedTable.style.display = "none";
                    deniedTable.style.display = "table";
                } else {
                    pendingTable.style.display = "table";
                    approvedTable.style.display = "none";
                    deniedTable.style.display = "none";
                }
            };

            // Prevent modal from opening when clicking on action buttons
            actionButtons.forEach(button => {
                button.addEventListener("click", (event) => {
                    event.stopPropagation();
                });
            });

            // Handle row click to open modal and populate post details
            rows.forEach(row => {
                row.addEventListener("click", function () {
                    const name = this.cells[0].textContent.trim() || "N/A";
                    const content = this.cells[2].textContent.trim() || "N/A";
                    const date = this.cells[3].textContent.trim() || "N/A";
                    const imageSrc = this.querySelector("img")?.src || "N/A";

                    document.getElementById("postName").textContent = name;
                    document.getElementById("postContent").textContent = content;
                    document.getElementById("postDate").textContent = date;
                    document.getElementById("postImage").textContent = "N/A";
                    document.getElementById("postTag").textContent = "N/A";

                    modal.style.display = "flex";
                });
            });

            // Close modal functionality
            closeModalButton.addEventListener("click", () => {
                modal.style.display = "none";
            });

            window.addEventListener("click", (event) => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });

            // Handle filter buttons (Pending, Approved, Denied)
            statusButtons.forEach(button => {
                button.addEventListener("click", () => {
                    const status = button.classList.contains("pending")
                        ? "pending"
                        : button.classList.contains("approved")
                            ? "approved"
                            : "denied";

                    // Toggle between tables based on status
                    toggleTable(status);
                });
            });
        });
    </script>

    <!-- Script for Sorting -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const tables = document.querySelectorAll(".post-table");

            function sortTable(table, columnIndex, isAscending) {
                const tbody = table.querySelector("tbody");
                const rows = Array.from(tbody.rows);

                rows.sort((a, b) => {
                    const cellA = a.cells[columnIndex].textContent.trim();
                    const cellB = b.cells[columnIndex].textContent.trim();

                    if (!isNaN(Date.parse(cellA)) && !isNaN(Date.parse(cellB))) {
                        return isAscending ? new Date(cellA) - new Date(cellB) : new Date(cellB) - new Date(cellA);
                    }

                    if (!isNaN(cellA) && !isNaN(cellB)) {
                        return isAscending ? cellA - cellB : cellB - cellA;
                    }

                    return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
                });

                rows.forEach(row => tbody.appendChild(row));
            }

            function toggleSort(button, table, columnIndex) {
                const isAscending = button.dataset.sort === "asc";
                button.dataset.sort = isAscending ? "desc" : "asc";
                sortTable(table, columnIndex, !isAscending);
            }

            tables.forEach(table => {
                const sortButtons = table.querySelectorAll(".sort-button");

                sortButtons.forEach((button, index) => {
                    button.addEventListener("click", () => toggleSort(button, table, index));
                });
            });
        });
    </script>

    <!-- Script for Search Input -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const searchInput = document.querySelector(".search-input");
            const tables = document.querySelectorAll(".post-table");

            const filterRows = (searchValue) => {
                tables.forEach((table) => {
                    const rows = table.querySelectorAll("tbody tr");
                    rows.forEach((row) => {
                        const cells = row.querySelectorAll("td");
                        const rowText = Array.from(cells)
                            .map((cell) => cell.textContent.toLowerCase())
                            .join(" ");
                        if (rowText.includes(searchValue.toLowerCase())) {
                            row.style.display = "";
                        } else {
                            row.style.display = "none";
                        }
                    });
                });
            };

            searchInput.addEventListener("input", (event) => {
                const searchValue = event.target.value.trim();
                filterRows(searchValue);
            });
        });
    </script>

    <!-- Script for Populating Tables and Button Functionalities-->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          // Fetch and populate posts
          fetch('/api/posts/status')
            .then((response) => {
              if (!response.ok) {
                throw new Error('Failed to fetch posts');
              }
              return response.json();
            })
            .then((data) => {
              populateTable('pending-table', data.pending);
              populateTable('approved-table', data.approved);
              populateTable('denied-table', data.rejected);
            })
            .catch((error) => {
              console.error('Error fetching posts:', error);
            });
      
          // Event listeners for approve/reject/view-details buttons
          document.addEventListener('click', (event) => {
            if (event.target.classList.contains('approve')) {
              const row = event.target.closest('tr');
              moveToTable(row, 'approved-table');
              updatePostStatus(getPostIdFromRow(row), 'approved');
            } else if (event.target.classList.contains('deny')) {
              const row = event.target.closest('tr');
              moveToTable(row, 'denied-table');
              updatePostStatus(getPostIdFromRow(row), 'rejected');
            } else if (event.target.classList.contains('view-details')) {
              const postId = event.target.dataset.id;
              openPostDetailsModal(postId);
            }
          });
      
          // Close modal functionality
          const closeModalButton = document.getElementById('closeModal');
          if (closeModalButton) {
            closeModalButton.addEventListener('click', () => {
              const modal = document.getElementById('postDetailsModal');
              modal.style.display = 'none';
            });
          }
      
          // Close modal when clicking outside
          window.addEventListener('click', (event) => {
            const modal = document.getElementById('postDetailsModal');
            if (event.target === modal) {
              modal.style.display = 'none';
            }
          });
        });
      
        // Function to populate a table with post data
        function populateTable(tableClass, posts) {
            const tableBody = document.querySelector(`.${tableClass} tbody`);
            tableBody.innerHTML = '';

            posts.forEach(post => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${post.post_id}</td>
                    <td>${post.email}</td>
                    <td>${post.author}</td>
                    <td>${post.content}</td>
                    <td>${new Date(post.date).toLocaleDateString()}</td>
                    <td class="action-buttons">
                        ${tableClass === 'pending-table' ? `
                            <button class="btn approve" data-id="${post.post_id}">Approve</button>
                            <button class="btn deny" data-id="${post.post_id}">Deny</button>
                        ` : ''}
                        <button class="btn view-details" data-id="${post.post_id}">View Details</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

      
        // Function to move a row to a different table
        function moveToTable(row, targetTableClass) {
          const targetTableBody = document.querySelector(`.${targetTableClass} tbody`);
          row.querySelector('.action-buttons').innerHTML = ''; 
          targetTableBody.appendChild(row); 
        }
      
        // Function to extract post ID from the row
        function getPostIdFromRow(row) {
            const viewDetailsButton = row.querySelector('.view-details');
            if (!viewDetailsButton) {
                console.error('No data-id found for row:', row);
                return null;
            }
            return viewDetailsButton.dataset.id;
        }
      
        // Function to update post status in the database
        function updatePostStatus(postId, status) {
          fetch('/api/posts/updateStatus', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: postId, status }),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error('Failed to update post status');
              }
              return response.json();
            })
            .then((data) => {
              console.log(data.message);
            })
            .catch((error) => {
              console.error('Error updating post status:', error);
            });
        }
      
        // Function to open the modal and fetch post details
        function openPostDetailsModal(postId) {
          const modal = document.getElementById('postDetailsModal');
      
          fetch(`/api/posts/details/${postId}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error('Failed to fetch post details');
              }
              return response.json();
            })
            .then((data) => {
              document.getElementById('postEmail').innerText = data.email || 'N/A';
              document.getElementById('postAuthor').innerText = data.author || 'N/A';
              document.getElementById('postContent').innerText = data.content || 'N/A';
              document.getElementById('postDate').innerText = new Date(data.date).toLocaleDateString() || 'N/A';
              document.getElementById('postSchool').innerText = data.school || 'N/A';
              document.getElementById('postCourse').innerText = data.course || 'N/A';
              document.getElementById('postBatch').innerText = data.batch || 'N/A';
      
              const postImage = document.getElementById('postImage');
              if (data.image) {
                postImage.src = `data:image/jpeg;base64,${data.image}`;
                postImage.style.display = 'block';
              } else {
                postImage.style.display = 'none';
              }
      
              modal.style.display = 'block';
            })
            .catch((error) => console.error('Error fetching post details:', error));
        }
    </script>
      
</body>

</html>