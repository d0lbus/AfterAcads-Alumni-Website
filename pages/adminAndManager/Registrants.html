<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrants</title>
  <link rel="stylesheet"
    href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css" />
  <link rel="stylesheet" href="../../style/adminAndManager/Registrants.css" />
  <script src="script.js" defer></script>
</head>

<body>
  <section>
    <header>
      <div>
        <img class="afteracadstext" src="../../assets/logo.png" alt="AfterAcads" />
      </div>
      <!-- Citation: navigation bar - (https://www.youtube.com/watch?v=oLgtucwjVII) -->
      <ul class="nav-links">
        <li><a href="home.html">Home</a></li>
        <li><a href="Registrants.html">Registrants</a></li>
        <li><a href="approvePost.html">Posts</a></li>
        <li><a href="eventsDashboard.html">Events</a></li>
        <li><a href="opportunities.html">Opportunities</a></li>
        <li><a href="statistics.php">Statistics</a></li>
        <li><a href="user.html">Users</a></li>
    </ul>
      <div class="profile">
        <li><a href="managerProfile.html"><img class="profile-img"
              src="../../assets/profileIcon.jpg" alt="Profile" /></a>
        </li>
      </div>
    </header>
  </section>

  <div class="users-section container">
    <div class="search-and-buttons">
      <input type="text" class="search-input" placeholder="Search..." />
      <div class="button-group">
        <button class="btn pending">Pending Users</button>
        <button class="btn approved">Approved Users</button>
        <button class="btn denied">Denied Users</button>
      </div>
    </div>

    <!-- Table for Pending Users -->
    <table class="user-table pending-table">
      <thead>
        <tr>
          <th>First Name
              <button class="sort-button" data-sort="asc" onclick="toggleSort(this, 2)">
                  <span class="arrow-up">&#9650;</span>
                  <span class="arrow-down">&#9660;</span>
              </button>
          </th>
          </th>
          <th>Last Name
            <button class="sort-button" data-sort="asc" onclick="toggleSort(this, 2)">
              <span class="arrow-up">&#9650;</span>
              <span class="arrow-down">&#9660;</span>
            </button>
          </th>
          <th>E-mail
            <button class="sort-button" data-sort="asc" onclick="toggleSort(this, 2)">
              <span class="arrow-up">&#9650;</span>
              <span class="arrow-down">&#9660;</span>
            </button>
          </th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dynamic Rows Here -->
      </tbody>
    </table>

    <!-- Table for Approved Users -->
    <table class="user-table approved-table" style="display: none;">
      <thead>
        <tr>
          <th>First Name</th>
          <th>Last Name</th>
          <th>E-mail</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dynamic Rows Here -->
      </tbody>
    </table>

    <!-- Table for Denied Users -->
    <table class="user-table denied-table" style="display: none;">
      <thead>
        <tr>
          <th>First Name</th>
          <th>Last Name</th>
          <th>E-mail</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dynamic Rows Here -->
      </tbody>
    </table>
  </div>

  <div class="user-details-modal" id="userDetailsModal" style="display: none;"> 
    <div class="modal-content">
        <span class="close-btn" id="closeModal">&times;</span>
        <h2>User Details</h2>
        <hr class="modal-divider">
        <p><strong>First Name:</strong> <span id="firstName"></span></p>
        <p><strong>Middle Name:</strong> <span id="middleName"></span></p>
        <p><strong>Last Name:</strong> <span id="lastName"></span></p>
        <p><strong>Gender:</strong> <span id="gender"></span></p>
        <p><strong>E-mail:</strong> <span id="email"></span></p>
        <p><strong>Alumni Photo for Validation:</strong></p>
        <img id="alumniPhoto" style="display: none; max-width: 100%;"/>
    </div>
  </div>

  <!-- Script for the Tables -->
  <!-- Citation: JavaScript for the tables - (https://www.youtube.com/watch?v=XmdOZ5NSqb8&list=PL-51WBLyFTg1l3K0aTH0uX6PzgaLfzJBK)  -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const rows = document.querySelectorAll(".user-table tbody tr");
      const modal = document.getElementById("userDetailsModal");
      const closeModalButton = document.getElementById("closeModal");
      const statusButtons = document.querySelectorAll(".button-group .btn");

      // Function to switch between tables
      const toggleTable = (status) => {
        const pendingTable = document.querySelector(".pending-table");
        const approvedTable = document.querySelector(".approved-table");
        const deniedTable = document.querySelector(".denied-table");

        if (status === "approved") {
          pendingTable.style.display = "none";
          approvedTable.style.display = "table";
          deniedTable.style.display = "none";
        } else if (status === "denied") {
          pendingTable.style.display = "none";
          approvedTable.style.display = "none";
          deniedTable.style.display = "table";
        } else {
          pendingTable.style.display = "table";
          approvedTable.style.display = "none";
          deniedTable.style.display = "none";
        }
      };

      // Prevent modal from opening when clicking on buttons
      const actionButtons = document.querySelectorAll(".action-buttons button");
      actionButtons.forEach(button => {
        button.addEventListener("click", (event) => {
          event.stopPropagation();
        });
      });

      // Handle row click to open modal and populate user details
      rows.forEach(row => {
        row.addEventListener("click", function () {
          const firstName = this.cells[0].textContent.trim() || "N/A";
          const lastName = this.cells[1].textContent.trim() || "N/A";
          const email = this.cells[2].textContent.trim() || "N/A";

          // Populate modal with details from the clicked row
          document.getElementById("firstName").textContent = firstName;
          document.getElementById("lastName").textContent = lastName;
          document.getElementById("email").textContent = email;
          document.getElementById("middleName").textContent = "N/A";
          document.getElementById("gender").textContent = "N/A";

          // Open the modal
          modal.style.display = "flex";
        });
      });

      // Close modal functionality
      closeModalButton.addEventListener("click", () => {
        modal.style.display = "none";
      });

      window.addEventListener("click", (event) => {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });

      // Handle filter buttons (Pending, Approved, Denied)
      statusButtons.forEach(button => {
        button.addEventListener("click", () => {
          const status = button.classList.contains("pending")
            ? "pending"
            : button.classList.contains("approved")
              ? "approved"
              : "denied";

          toggleTable(status);
        });
      });
    });

  </script>

  <!-- Script for Sorting -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tables = document.querySelectorAll(".user-table");

      function sortTable(table, columnIndex, isAscending) {
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.rows);

        rows.sort((a, b) => {
          const cellA = a.cells[columnIndex].textContent.trim();
          const cellB = b.cells[columnIndex].textContent.trim();

          if (!isNaN(Date.parse(cellA)) && !isNaN(Date.parse(cellB))) {
            return isAscending ? new Date(cellA) - new Date(cellB) : new Date(cellB) - new Date(cellA);
          }

          if (!isNaN(cellA) && !isNaN(cellB)) {
            return isAscending ? cellA - cellB : cellB - cellA;
          }

          return isAscending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
        });

        rows.forEach(row => tbody.appendChild(row));
      }

      function toggleSort(button, table, columnIndex) {
        const isAscending = button.dataset.sort === "asc";
        button.dataset.sort = isAscending ? "desc" : "asc";
        sortTable(table, columnIndex, !isAscending);
      }

      tables.forEach(table => {
        const sortButtons = table.querySelectorAll(".sort-button");

        sortButtons.forEach((button, index) => {
          button.addEventListener("click", () => toggleSort(button, table, index));
        });
      });
    });

  </script>

  <!-- Script for Search Input -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.querySelector(".search-input");
      const tables = document.querySelectorAll(".user-table");

      const filterRows = (searchValue) => {
        tables.forEach((table) => {
          const rows = table.querySelectorAll("tbody tr");
          rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const rowText = Array.from(cells)
              .map((cell) => cell.textContent.toLowerCase())
              .join(" ");
            if (rowText.includes(searchValue.toLowerCase())) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });
      };

      searchInput.addEventListener("input", (event) => {
        const searchValue = event.target.value.trim();
        filterRows(searchValue);
      });
    });

  </script>

  <!-- Script for Populating Tables and Button Functionalities-->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Fetch and populate users
        fetch('/api/users/status')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch users');
                }
                return response.json();
            })
            .then(data => {
                populateTable('pending-table', data.pending);
                populateTable('approved-table', data.approved);
                populateTable('denied-table', data.denied);
            })
            .catch(error => {
                console.error('Error fetching users:', error);
            });

        // Attach event listener for approve/deny/view-details buttons
        document.addEventListener('click', event => {
            if (event.target.classList.contains('approve')) {
                // Approve button functionality
                const row = event.target.closest('tr');
                moveToTable(row, 'approved-table');
                updateUserStatus(getEmailFromRow(row), 'approved');
            } else if (event.target.classList.contains('deny')) {
                // Deny (Reject) button functionality
                const row = event.target.closest('tr');
                moveToTable(row, 'denied-table');
                updateUserStatus(getEmailFromRow(row), 'rejected');
            } else if (event.target.classList.contains('view-details')) {
                // View Details button functionality
                const email = event.target.dataset.email;
                openUserDetailsModal(email);
            }
        });

        // Close modal functionality
        const closeModalButton = document.getElementById('closeModal');
        if (closeModalButton) {
            closeModalButton.addEventListener('click', () => {
                const modal = document.getElementById('userDetailsModal');
                modal.style.display = 'none';
            });
        }

        // Close modal when clicking outside the modal content
        window.addEventListener('click', event => {
            const modal = document.getElementById('userDetailsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });

    // Function to populate a table with user data
    function populateTable(tableClass, users) {
        const tableBody = document.querySelector(`.${tableClass} tbody`);
        tableBody.innerHTML = '';

        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="user-info">
                        <img class="user-avatar" src="../../assets/profileIcon.jpg" alt="user avatar" />
                        <span class="username">${user.first_name}</span>
                    </div>
                </td>
                <td>${user.last_name}</td>
                <td>${user.email}</td>
                <td class="action-buttons">
                    ${tableClass === 'pending-table' ? `
                        <button class="btn approve">Approve</button>
                        <button class="btn deny">Deny</button>
                    ` : ''}
                    <button class="btn view-details" data-email="${user.email}">View Details</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Function to move a row to a different table
    function moveToTable(row, targetTableClass) {
        const targetTableBody = document.querySelector(`.${targetTableClass} tbody`);
        row.querySelector('.action-buttons').innerHTML = ''; // Clear action buttons for the new table
        targetTableBody.appendChild(row); // Append row to the new table
    }

    // Function to extract email from the row
    function getEmailFromRow(row) {
        return row.querySelector('td:nth-child(3)').innerText.trim();
    }

    // Function to update user status in the database
    function updateUserStatus(email, status) {
      console.log('Updating status:', { email, status });
        fetch('/api/users/updateStatus', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, status }),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update status');
                }
                return response.json();
            })
            .then(data => {
                console.log(data.message);
            })
            .catch(error => {
                console.error('Error updating user status:', error);
            });
    }

    // Function to open the modal and fetch user details
    function openUserDetailsModal(email) {
        const modal = document.getElementById('userDetailsModal');
        const alumniPhotoElement = document.getElementById('alumniPhoto');

        console.log('Fetching details for email:', email);

        fetch(`/api/users/registrantdetails/${encodeURIComponent(email)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user details');
                }
                return response.json();
            })
            .then(data => {
                console.log('User data received:', data);

                // Populate modal fields
                document.getElementById('firstName').innerText = data.firstName || 'N/A';
                document.getElementById('middleName').innerText = data.middleName || 'N/A';
                document.getElementById('lastName').innerText = data.lastName || 'N/A';
                document.getElementById('email').innerText = data.email || 'N/A';
                document.getElementById('gender').innerText = data.gender || 'N/A';

                if (data.alumniPhotoValidation) {
                    alumniPhotoElement.src = `data:image/jpeg;base64,${data.alumniPhotoValidation}`;
                    alumniPhotoElement.style.display = 'block';
                } else {
                    alumniPhotoElement.style.display = 'none';
                }

                // Show the modal
                modal.style.display = 'block';
            })
            .catch(error => console.error('Error fetching user details:', error));
    }
  </script>

  
      
</body>

</html>